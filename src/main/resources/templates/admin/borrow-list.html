<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Quản lý Mượn Trả - Admin</title>

  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

  <link href="/css/sb-admin-2.min.css" rel="stylesheet">

  <link href="/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
</head>

<body id="page-top">

<div id="wrapper">

  <ul th:replace="~{admin/sidebar :: sidebar}"></ul>
  <div id="content-wrapper" class="d-flex flex-column">

    <div id="content">

      <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
          <i class="fa fa-bars"></i>
        </button>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
              <span class="mr-2 d-none d-lg-inline text-gray-600 small">Admin</span>
              <img class="img-profile rounded-circle" src="/img/undraw_profile.svg">
            </a>
          </li>
        </ul>
      </nav>
      <div class="container-fluid">

        <h1 class="h3 mb-2 text-gray-800">Quản lý Mượn Trả</h1>
        <p class="mb-4">Danh sách các yêu cầu mượn sách từ độc giả.</p>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
          <span th:text="${successMessage}"></span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <span th:text="${errorMessage}"></span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách Phiếu Mượn</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>Người mượn</th>
                  <th>Ngày mượn</th>
                  <th>Hạn trả</th>
                  <th>Trạng thái</th>
                  <th>Sách mượn</th>
                  <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="trans : ${transactions}">
                  <td th:text="${trans.id}"></td>
                  <td th:text="${trans.user.email}"></td>
                  <td th:text="${trans.borrowDate}"></td>
                  <td th:text="${trans.dueDate}"></td>

                  <td class="text-center">
                    <span th:if="${trans.status.name() == 'PENDING'}" class="badge badge-warning">Chờ duyệt</span>
                    <span th:if="${trans.status.name() == 'BORROWED'}" class="badge badge-primary">Đang mượn</span>
                    <span th:if="${trans.status.name() == 'RETURNED'}" class="badge badge-success">Đã trả</span>
                    <span th:if="${trans.status.name() == 'OVERDUE'}" class="badge badge-danger">Quá hạn</span>
                  </td>

                  <td>
                    <ul style="padding-left: 20px; margin-bottom: 0;">
                      <li th:each="detail : ${trans.details}" th:text="${detail.book.title}"></li>
                    </ul>
                  </td>

                  <td class="text-center">
                    <form th:if="${trans.status.name() == 'PENDING'}"
                          th:action="@{/admin/borrows/approve/{id}(id=${trans.id})}" method="post" style="display:inline;">
                      <button type="submit" class="btn btn-success btn-sm btn-icon-split">
                        <span class="icon text-white-50"><i class="fas fa-check"></i></span>
                        <span class="text">Duyệt</span>
                      </button>
                    </form>

                    <form th:if="${trans.status.name() == 'BORROWED' or trans.status.name() == 'OVERDUE'}"
                          th:action="@{/admin/borrows/return/{id}(id=${trans.id})}" method="post" style="display:inline;">
                      <button type="submit" class="btn btn-info btn-sm btn-icon-split"
                              onclick="return confirm('Xác nhận nhận lại sách?')">
                        <span class="icon text-white-50"><i class="fas fa-undo"></i></span>
                        <span class="text">Trả sách</span>
                      </button>
                    </form>

                    <span th:if="${trans.status.name() == 'RETURNED'}" class="text-secondary small">Hoàn tất</span>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
    <footer class="sticky-footer bg-white">
      <div class="container my-auto">
        <div class="copyright text-center my-auto">
          <span>Copyright &copy; Library System 2025</span>
        </div>
      </div>
    </footer>
  </div>
</div>
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>

<script src="/vendor/datatables/jquery.dataTables.min.js"></script>
<script src="/vendor/datatables/dataTables.bootstrap4.min.js"></script>

<script>
  $(document).ready(function() {
      $('#dataTable').DataTable();
  });
</script>

</body>
</html>